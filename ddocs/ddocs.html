<!--
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed
under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.1. Design Documents &mdash; Apache CouchDB® 2.3 Documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  
    <link rel="canonical" href="http://docs.couchdb.org/en/stable/ddocs/ddocs.html"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/css/rtd_theme.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../about.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Apache CouchDB® 2.3 Documentation" href="../index.html"/>
        <link rel="up" title="3. Design Documents" href="index.html"/>
        <link rel="next" title="3.2. Guide to Views" href="views/index.html"/>
        <link rel="prev" title="3. Design Documents" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Apache CouchDB®
          

          
            
            <img src="../_static/logo.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                2.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
<h2>Table of Contents</h2>

            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../replication/index.html">2. Replication</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">3. Design Documents</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">3.1. Design Documents</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#view-functions">3.1.1. View Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#map-functions">3.1.1.1. Map Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reduce-and-rereduce-functions">3.1.1.2. Reduce and Rereduce Functions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#show-functions">3.1.2. Show Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#list-functions">3.1.3. List Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#update-functions">3.1.4. Update Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filter-functions">3.1.5. Filter Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#classic-filters">3.1.5.1. Classic Filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#view-filters">3.1.5.2. View Filters</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#validate-document-update-functions">3.1.6. Validate Document Update Functions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="views/index.html">3.2. Guide to Views</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../best-practices/index.html">4. Best Practices</a></li>
</ul>
<p class="caption"><span class="caption-text">Administration Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install/index.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">2. Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config/index.html">3. Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster/index.html">4. Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintenance/index.html">5. Maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fauxton/index.html">6. Fauxton</a></li>
<li class="toctree-l1"><a class="reference internal" href="../experimental.html">7. Experimental Features</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">1. API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../json-structure.html">2. JSON Structure Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../query-server/index.html">3. Query Server</a></li>
</ul>
<p class="caption"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../whatsnew/index.html">1. Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cve/index.html">2. Security Issues / CVEs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cve/index.html#reporting-new-security-problems-with-apache-couchdb">3. Reporting New Security Problems with Apache CouchDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">4. License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">5. Contributing to this Documentation</a></li>
</ul>

            
          
<h2>Quick Reference Guides</h2>
<ul>
<li><a href="../http-api.html">API Quick Reference</a></li>
<li><a href="../config-ref.html">Configuration Quick Reference</a></li>
</ul>


<h2>Local Links</h2>
<ul>
<li><a href="../">Fauxton</a></li>
</ul>


<h2>More Help</h2>
<ul>
<li><a href="https://couchdb.apache.org/">CouchDB Homepage</a></li>
<li><a href="https://couchdb.apache.org/#mailing-list">Mailing Lists</a></li>
<li><a href="http://webchat.freenode.net/?channels=couchdb">IRC</a></li>
<li><a href="https://github.com/apache/couchdb/issues">Issue Tracker</a></li>
<li><a href="../download.html">Download Docs</a></li>
</ul>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Apache CouchDB®</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">3. Design Documents</a> &raquo;</li>
        
      <li>3.1. Design Documents</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/couchdb-documentation/blob/master/src/ddocs/ddocs.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="design-documents">
<span id="ddocs"></span><h1>3.1. Design Documents<a class="headerlink" href="#design-documents" title="Permalink to this headline">¶</a></h1>
<p>In this section we’ll show how to write design documents, using the built-in
<a class="reference internal" href="../query-server/javascript.html#query-server-js"><span class="std std-ref">JavaScript Query Server</span></a>.</p>
<p>But before we start to write our first document, let’s take a look at the list
of common objects that will be used during our code journey - we’ll be using
them extensively within each function:</p>
<ul class="simple">
<li><a class="reference internal" href="../json-structure.html#dbinfo-object"><span class="std std-ref">Database information object</span></a></li>
<li><a class="reference internal" href="../json-structure.html#request-object"><span class="std std-ref">Request object</span></a></li>
<li><a class="reference internal" href="../json-structure.html#response-object"><span class="std std-ref">Response object</span></a></li>
<li><a class="reference internal" href="../json-structure.html#userctx-object"><span class="std std-ref">UserCtx object</span></a></li>
<li><a class="reference internal" href="../json-structure.html#security-object"><span class="std std-ref">Database Security object</span></a></li>
<li><a class="reference internal" href="../query-server/javascript.html#query-server-js"><span class="std std-ref">Guide to JavaScript Query Server</span></a></li>
</ul>
<div class="section" id="view-functions">
<span id="viewfun"></span><h2>3.1.1. View Functions<a class="headerlink" href="#view-functions" title="Permalink to this headline">¶</a></h2>
<p>Views are the primary tool used for querying and reporting on CouchDB databases.</p>
<div class="section" id="map-functions">
<span id="mapfun"></span><h3>3.1.1.1. Map Functions<a class="headerlink" href="#map-functions" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt>
<code class="descname">mapfun</code><span class="sig-paren">(</span><em>doc</em><span class="sig-paren">)</span></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first last simple">
<li><strong>doc</strong> – The document that is being processed</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Map functions accept a single document as the argument and (optionally)
<a class="reference internal" href="../query-server/javascript.html#emit" title="emit"><code class="xref js js-func docutils literal"><span class="pre">emit()</span></code></a> key/value pairs that are stored in a view.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;post&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">doc</span><span class="p">.</span><span class="nx">tags</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">tag</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">emit</span><span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this example a key/value pair is emitted for each value in the <cite>tags</cite> array
of a document with a <cite>type</cite> of “post”. Note that <a class="reference internal" href="../query-server/javascript.html#emit" title="emit"><code class="xref js js-func docutils literal"><span class="pre">emit()</span></code></a> may be called many
times for a single document, so the same document may be available by several
different keys.</p>
<p>Also keep in mind that each document is <em>sealed</em> to prevent the situation where
one map function changes document state and another receives a modified version.</p>
<p>For efficiency reasons, documents are passed to a group of map functions - each
document is processed by a group of map functions from all views of the related
design document. This means that if you trigger an index update for one view in
the design document, all others will get updated too.</p>
<p>Since version <cite>1.1.0</cite>, <cite>map</cite> supports <a class="reference internal" href="../query-server/javascript.html#commonjs"><span class="std std-ref">CommonJS</span></a> modules and
the <a class="reference internal" href="../query-server/javascript.html#require" title="require"><code class="xref js js-func docutils literal"><span class="pre">require()</span></code></a> function.</p>
</div>
<div class="section" id="reduce-and-rereduce-functions">
<span id="reducefun"></span><h3>3.1.1.2. Reduce and Rereduce Functions<a class="headerlink" href="#reduce-and-rereduce-functions" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="redfun">
<code class="descname">redfun</code><span class="sig-paren">(</span><em>keys</em>, <em>values</em><span class="optional">[</span>, <em>rereduce</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#redfun" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>keys</strong> – Array of pairs of docid-key for related map function results.
Always <code class="docutils literal"><span class="pre">null</span></code> if rereduce is running (has <code class="docutils literal"><span class="pre">true</span></code> value).</li>
<li><strong>values</strong> – Array of map function result values.</li>
<li><strong>rereduce</strong> – Boolean flag to indicate a rereduce run.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Reduces <cite>values</cite></p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Reduce functions take two required arguments of keys and values lists - the
result of the related map function - and an optional third value which indicates
if <cite>rereduce</cite> mode is active or not. <cite>Rereduce</cite> is used for additional reduce
values list, so when it is <code class="docutils literal"><span class="pre">true</span></code> there is no information about related <cite>keys</cite>
(first argument is <code class="docutils literal"><span class="pre">null</span></code>).</p>
<p>Note that if the result of a <cite>reduce</cite> function is longer than the initial
values list then a Query Server error will be raised. However, this behavior
can be disabled by setting <code class="docutils literal"><span class="pre">reduce_limit</span></code> config option to <code class="docutils literal"><span class="pre">false</span></code>:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[query_server_config]</span>
<span class="na">reduce_limit</span> <span class="o">=</span> <span class="s">false</span>
</pre></div>
</div>
<p>While disabling <code class="docutils literal"><span class="pre">reduce_limit</span></code> might be useful for debug proposes, remember
that the main task of reduce functions is to <em>reduce</em> the mapped result, not to
make it bigger. Generally, your reduce function should converge rapidly to a
single value - which could be an array or similar object.</p>
<div class="section" id="built-in-reduce-functions">
<span id="reducefun-builtin"></span><h4>3.1.1.2.1. Built-in Reduce Functions<a class="headerlink" href="#built-in-reduce-functions" title="Permalink to this headline">¶</a></h4>
<p>Additionally, CouchDB has a set of built-in reduce functions. These are
implemented in Erlang and run inside CouchDB, so they are much faster than the
equivalent JavaScript functions.</p>
<dl class="data">
<dt id="_approx_count_distinct">
<code class="descname">_approx_count_distinct</code><a class="headerlink" href="#_approx_count_distinct" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="versionadded">
<p><span class="versionmodified">New in version 2.2.</span></p>
</div>
<p>Aproximates the number of distinct keys in a view index using a variant of the
<a class="reference external" href="https://en.wikipedia.org/wiki/HyperLogLog">HyperLogLog</a> algorithm. This algorithm enables an efficient, parallelizable
computation of cardinality using fixed memory resources. CouchDB has configured
the underlying data structure to have a relative error of ~2%.</p>
<p>As this reducer ignores the emitted values entirely, an invocation with
<code class="docutils literal"><span class="pre">group=true</span></code> will simply return a value of 1 for every distinct key in the
view. In the case of array keys, querying the view with a <code class="docutils literal"><span class="pre">group_level</span></code>
specified will return the number of distinct keys that share the common group
prefix in each row. The algorithm is also cognizant of the <code class="docutils literal"><span class="pre">startkey</span></code> and
<code class="docutils literal"><span class="pre">endkey</span></code> boundaries and will return the number of distinct keys within the
specified key range.</p>
<p>A final note regarding Unicode collation: this reduce function uses the binary
representation of each key in the index directly as input to the HyperLogLog
filter. As such, it will (incorrectly) consider keys that are not byte identical
but that compare equal according to the Unicode collation rules to be distinct
keys, and thus has the potential to overestimate the cardinality of the key
space if a large number of such keys exist.</p>
<dl class="data">
<dt id="_count">
<code class="descname">_count</code><a class="headerlink" href="#_count" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Counts the number of values in the index with a given key. This could be
implemented in JavaScript as:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// could be replaced by _count</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="data">
<dt id="_stats">
<code class="descname">_stats</code><a class="headerlink" href="#_stats" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Computes the following quantities for numeric values associated with each key:
<code class="docutils literal"><span class="pre">sum</span></code>, <code class="docutils literal"><span class="pre">min</span></code>, <code class="docutils literal"><span class="pre">max</span></code>, <code class="docutils literal"><span class="pre">count</span></code>, and <code class="docutils literal"><span class="pre">sumsqr</span></code>. The behavior of the
<code class="docutils literal"><span class="pre">_stats</span></code> function varies depending on the output of the map function. The
simplest case is when the map phase emits a single numeric value for each key.
In this case the <code class="docutils literal"><span class="pre">_stats</span></code> function is equivalent to the following JavaScript:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// could be replaced by _stats</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">rereduce</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;sum&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sum</span> <span class="p">},</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;min&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">min</span><span class="p">)</span> <span class="p">},</span> <span class="kc">Infinity</span><span class="p">),</span>
            <span class="s1">&#39;max&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">max</span><span class="p">)</span> <span class="p">},</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">),</span>
            <span class="s1">&#39;count&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">count</span> <span class="p">},</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s1">&#39;sumsqr&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sumsqr</span> <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;sum&#39;</span><span class="o">:</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">),</span>
            <span class="s1">&#39;min&#39;</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">values</span><span class="p">),</span>
            <span class="s1">&#39;max&#39;</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">values</span><span class="p">),</span>
            <span class="s1">&#39;count&#39;</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
            <span class="s1">&#39;sumsqr&#39;</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">sumsqr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="nx">values</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">sumsqr</span> <span class="o">+=</span> <span class="nx">value</span> <span class="o">*</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">});</span>

            <span class="k">return</span> <span class="nx">sumsqr</span><span class="p">;</span>
            <span class="p">})(),</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">_stats</span></code> function will also work with “pre-aggregated” values from a map
phase. A map function that emits an object containing <code class="docutils literal"><span class="pre">sum</span></code>, <code class="docutils literal"><span class="pre">min</span></code>, <code class="docutils literal"><span class="pre">max</span></code>,
<code class="docutils literal"><span class="pre">count</span></code>, and <code class="docutils literal"><span class="pre">sumsqr</span></code> keys and numeric values for each can use the
<code class="docutils literal"><span class="pre">_stats</span></code> function to combine these results with the data from other documents.
The emitted object may contain other keys (these are ignored by the reducer),
and it is also possible to mix raw numeric values and pre-aggregated objects
in a single view and obtain the correct aggregated statistics.</p>
<p>Finally, <code class="docutils literal"><span class="pre">_stats</span></code> can operate on key-value pairs where each value is an array
comprised of numbers or pre-aggregated objects. In this case <strong>every</strong> value
emitted from the map function must be an array, and the arrays must all be the
same length, as <code class="docutils literal"><span class="pre">_stats</span></code> will compute the statistical quantities above
<em>independently</em> for each element in the array. Users who want to compute
statistics on multiple values from a single document should either <code class="docutils literal"><span class="pre">emit</span></code> each
value into the index separately, or compute the statistics for the set of values
using the JavaScript example above and emit a pre-aggregated object.</p>
<dl class="data">
<dt id="_sum">
<code class="descname">_sum</code><a class="headerlink" href="#_sum" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>In its simplest variation, <code class="docutils literal"><span class="pre">_sum</span></code> sums the numeric values associated with each
key, as in the following JavaScript:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// could be replaced by _sum</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As with <code class="docutils literal"><span class="pre">_stats</span></code>, the <code class="docutils literal"><span class="pre">_sum</span></code> function offers a number of extended
capabilities. The <code class="docutils literal"><span class="pre">_sum</span></code> function requires that map values be numbers, arrays
of numbers, or objects. When presented with array output from a map function,
<code class="docutils literal"><span class="pre">_sum</span></code> will compute the sum for every element of the array. A bare numeric
value will be treated as an array with a single element, and arrays with fewer
elements will be treated as if they contained zeroes for every additional
element in the longest emitted array. As an example, consider the following map
output:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;total_rows&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;offset&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;rows&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;id1&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;id2&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;id2&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;def&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">42</span><span class="p">]},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;id2&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;ghi&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;id1&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;ghi&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">_sum</span></code> for this output without any grouping would be:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">42</span><span class="p">]}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>while the grouped output would be</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;rows&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]},</span>
    <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;def&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">42</span><span class="p">]},</span>
    <span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="o">:</span><span class="s2">&quot;ghi&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="mi">4</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>This is in contrast to the behavior of the <code class="docutils literal"><span class="pre">_stats</span></code> function which requires
that all emitted values be arrays of identical length if any array is emitted.</p>
<p>It is also possible to have <code class="docutils literal"><span class="pre">_sum</span></code> recursively descend through an emitted
object and compute the sums for every field in the object. Objects <em>cannot</em> be
mixed with other data structures. Objects can be arbitrarily nested, provided
that the values for all fields are themselves numbers, arrays of numbers, or
objects.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Why don’t reduce functions support CommonJS modules?</strong></p>
<p>While <cite>map</cite> functions have limited access to stored modules through
<a class="reference internal" href="../query-server/javascript.html#require" title="require"><code class="xref js js-func docutils literal"><span class="pre">require()</span></code></a>, there is no such feature for <cite>reduce</cite> functions.
The reason lies deep inside the way <cite>map</cite> and <cite>reduce</cite>
functions are processed by the Query Server. Let’s take a look at <cite>map</cite>
functions first:</p>
<ol class="arabic simple">
<li>CouchDB sends all <cite>map</cite> functions in a processed design document to the
Query Server.</li>
<li>the Query Server handles them one by one, compiles and puts them onto an
internal stack.</li>
<li>after all <cite>map</cite> functions have been processed, CouchDB will send the
remaining documents for indexing, one by one.</li>
<li>the Query Server receives the document object and applies it to every
function from the stack. The emitted results are then joined into a
single array and sent back to CouchDB.</li>
</ol>
<p>Now let’s see how <cite>reduce</cite> functions are handled:</p>
<ol class="arabic simple">
<li>CouchDB sends <em>as a single command</em> the list of available <cite>reduce</cite>
functions with the result list of key-value pairs that were previously
returned from the <cite>map</cite> functions.</li>
<li>the Query Server compiles the reduce functions and applies them to the
key-value lists. The reduced result is sent back to CouchDB.</li>
</ol>
<p class="last">As you may note, <cite>reduce</cite> functions are applied in a single shot to the map
results while <cite>map</cite> functions are applied to documents one by one. This
means that it’s possible for <cite>map</cite> functions to precompile CommonJS
libraries and use them during the entire view processing, but for <cite>reduce</cite>
functions they would be compiled again and again for each view result
reduction, which would lead to performance degradation.</p>
</div>
</div>
</div>
</div>
<div class="section" id="show-functions">
<span id="showfun"></span><h2>3.1.2. Show Functions<a class="headerlink" href="#show-functions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt>
<code class="descname">showfun</code><span class="sig-paren">(</span><em>doc</em>, <em>req</em><span class="sig-paren">)</span></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>doc</strong> – The document that is being processed; may be omitted.</li>
<li><strong>req</strong> – <a class="reference internal" href="../json-structure.html#request-object"><span class="std std-ref">Request object</span></a>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first"><a class="reference internal" href="../json-structure.html#response-object"><span class="std std-ref">Response object</span></a></p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">object or string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Show functions are used to represent documents in various formats, commonly as
HTML pages with nice formatting. They can also be used to run server-side
functions without requiring a pre-existing document.</p>
<p>Basic example of show function could be:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;Hello from &quot;</span> <span class="o">+</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;Hello, world!&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Also, there is more simple way to return json encoded data:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;json&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">],</span>
            <span class="s1">&#39;rev&#39;</span><span class="o">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;_rev&#39;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and even files (this one is CouchDB logo):</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;Content-Type&#39;</span> <span class="o">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s1">&#39;base64&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
            <span class="s1">&#39;iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAAsV&#39;</span><span class="p">,</span>
            <span class="s1">&#39;BMVEUAAAD////////////////////////5ur3rEBn////////////////wDBL/&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AADuBAe9EB3IEBz/7+//X1/qBQn2AgP/f3/ilpzsDxfpChDtDhXeCA76AQH/v7&#39;</span><span class="p">,</span>
            <span class="s1">&#39;/84eLyWV/uc3bJPEf/Dw/uw8bRWmP1h4zxSlD6YGHuQ0f6g4XyQkXvCA36MDH6&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wMH/z8/yAwX64ODeh47BHiv/Ly/20dLQLTj98PDXWmP/Pz//39/wGyJ7Iy9JAA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;AADHRSTlMAbw8vf08/bz+Pv19jK/W3AAAAg0lEQVR4Xp3LRQ4DQRBD0QqTm4Y5&#39;</span><span class="p">,</span>
            <span class="s1">&#39;zMxw/4OleiJlHeUtv2X6RbNO1Uqj9g0RMCuQO0vBIg4vMFeOpCWIWmDOw82fZx&#39;</span><span class="p">,</span>
            <span class="s1">&#39;vaND1c8OG4vrdOqD8YwgpDYDxRgkSm5rwu0nQVBJuMg++pLXZyr5jnc1BaH4GT&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LvEliY253nA3pVhQqdPt0f/erJkMGMB8xucAAAAASUVORK5CYII=&#39;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>But what if you need to represent data in different formats via a single
function? Functions <a class="reference internal" href="../query-server/javascript.html#registerType" title="registerType"><code class="xref js js-func docutils literal"><span class="pre">registerType()</span></code></a> and <a class="reference internal" href="../query-server/javascript.html#provides" title="provides"><code class="xref js js-func docutils literal"><span class="pre">provides()</span></code></a> are your the best
friends in that question:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="nx">provides</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="o">:</span> <span class="nx">doc</span><span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">provides</span><span class="p">(</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;pre&gt;&#39;</span> <span class="o">+</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/pre&gt;&#39;</span>
    <span class="p">})</span>
    <span class="nx">provides</span><span class="p">(</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/xml&#39;</span><span class="p">},</span>
            <span class="s1">&#39;body&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
                <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&#39;</span><span class="p">,</span>
                <span class="s1">&#39;&lt;doc&gt;&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
                    <span class="nx">escape</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">){</span>
                        <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;quot;/g</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;gt;/g</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;lt;/g</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
                                <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&amp;amp;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
                    <span class="p">};</span>
                    <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">doc</span><span class="p">){</span>
                        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">doc</span><span class="p">[</span><span class="nx">key</span><span class="p">]));</span>
                        <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
                        <span class="nx">content</span> <span class="o">+=</span> <span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
                            <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
                            <span class="nx">value</span>
                            <span class="s1">&#39;&lt;/&#39;</span> <span class="o">+</span> <span class="nx">key</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span>
                        <span class="p">)</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">content</span><span class="p">;</span>
                <span class="p">})(),</span>
                <span class="s1">&#39;&lt;/doc&gt;&#39;</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">registerType</span><span class="p">(</span><span class="s1">&#39;text-json&#39;</span><span class="p">,</span> <span class="s1">&#39;text/json&#39;</span><span class="p">)</span>
    <span class="nx">provides</span><span class="p">(</span><span class="s1">&#39;text-json&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function may return <cite>html</cite>, <cite>json</cite> , <cite>xml</cite> or our custom <cite>text json</cite> format
representation of same document object with same processing rules. Probably,
the <cite>xml</cite> provider in our function needs more care to handle nested objects
correctly, and keys with invalid characters, but you’ve got the idea!</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Guide:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://guide.couchdb.org/editions/1/en/show.html">Show Functions</a></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="list-functions">
<span id="listfun"></span><h2>3.1.3. List Functions<a class="headerlink" href="#list-functions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt>
<code class="descname">listfun</code><span class="sig-paren">(</span><em>head</em>, <em>req</em><span class="sig-paren">)</span></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>head</strong> – <a class="reference internal" href="../json-structure.html#view-head-info-object"><span class="std std-ref">View Head Information</span></a></li>
<li><strong>req</strong> – <a class="reference internal" href="../json-structure.html#request-object"><span class="std std-ref">Request object</span></a>.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first">Last chunk.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last">string</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>While <a class="reference internal" href="#showfun"><span class="std std-ref">Show Functions</span></a> are used to customize document presentation, <a class="reference internal" href="#listfun"><span class="std std-ref">List Functions</span></a>
are used for the same purpose, but on <a class="reference internal" href="#viewfun"><span class="std std-ref">View Functions</span></a> results.</p>
<p>The following list function formats the view and represents it as a very simple
HTML page:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">head</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="nx">start</span><span class="p">({</span>
        <span class="s1">&#39;headers&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;text/html&#39;</span>
        <span class="p">}</span>
    <span class="p">});</span>
    <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&lt;html&gt;&lt;body&gt;&lt;table&gt;&#39;</span><span class="p">);</span>
    <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;Key&lt;/th&gt;&lt;th&gt;Value&lt;/th&gt;&lt;/tr&gt;&#39;</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">row</span> <span class="o">=</span> <span class="nx">getRow</span><span class="p">()){</span>
        <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span>
            <span class="s1">&#39;&lt;tr&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&lt;td&gt;&#39;</span> <span class="o">+</span> <span class="nx">toJSON</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;&lt;/tr&gt;&#39;</span>
        <span class="p">));</span>
    <span class="p">}</span>
    <span class="nx">send</span><span class="p">(</span><span class="s1">&#39;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Templates and styles could obviously be used to present data in a nicer fashion,
but this is an excellent starting point. Note that you may also use
<a class="reference internal" href="../query-server/javascript.html#registerType" title="registerType"><code class="xref js js-func docutils literal"><span class="pre">registerType()</span></code></a> and <a class="reference internal" href="../query-server/javascript.html#provides" title="provides"><code class="xref js js-func docutils literal"><span class="pre">provides()</span></code></a> functions in a similar way as for
<a class="reference internal" href="#showfun"><span class="std std-ref">Show Functions</span></a>! However, note that <a class="reference internal" href="../query-server/javascript.html#provides" title="provides"><code class="xref js js-func docutils literal"><span class="pre">provides()</span></code></a> expects the return value to
be a string when used inside a list function, so you’ll need to use
<a class="reference internal" href="../query-server/javascript.html#start" title="start"><code class="xref js js-func docutils literal"><span class="pre">start()</span></code></a> to set any custom headers and stringify your JSON before
returning it.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Guide:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://guide.couchdb.org/draft/transforming.html">Transforming Views with List Functions</a></li>
</ul>
</dd>
</dl>
</div>
</div>
<div class="section" id="update-functions">
<span id="updatefun"></span><h2>3.1.4. Update Functions<a class="headerlink" href="#update-functions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt>
<code class="descname">updatefun</code><span class="sig-paren">(</span><em>doc</em>, <em>req</em><span class="sig-paren">)</span></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>doc</strong> – The document that is being processed.</li>
<li><strong>req</strong> – <a class="reference internal" href="../json-structure.html#request-object"><span class="std std-ref">Request object</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Two-element array: the first element is the (updated or new)
document, which is committed to the database. If the first element
is <code class="docutils literal"><span class="pre">null</span></code> no document will be committed to the database.
If you are updating an existing document, it should already have an
<code class="docutils literal"><span class="pre">_id</span></code> set, and if you are creating a new document, make sure to set its
<code class="docutils literal"><span class="pre">_id</span></code> to something, either generated based on the input or the
<code class="docutils literal"><span class="pre">req.uuid</span></code> provided. The second element is the response that will
be sent back to the caller.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Update handlers are functions that clients can request to invoke server-side
logic that will create or update a document. This feature allows a range of use
cases such as providing a server-side last modified timestamp, updating
individual fields in a document without first getting the latest revision, etc.</p>
<p>When the request to an update handler includes a document ID in the URL, the
server will provide the function with the most recent version of that document.
You can provide any other values needed by the update handler function via the
<code class="docutils literal"><span class="pre">POST</span></code>/<code class="docutils literal"><span class="pre">PUT</span></code> entity body or query string parameters of the request.</p>
<p>A basic example that demonstrates all use-cases of update handlers:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">doc</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span> <span class="k">in</span> <span class="nx">req</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]){</span>
            <span class="c1">// create new document</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;_id&#39;</span><span class="o">:</span> <span class="nx">req</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]},</span> <span class="s1">&#39;New World&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="c1">// change nothing in database</span>
        <span class="k">return</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;Empty World&#39;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;world&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hello&#39;</span><span class="p">;</span>
    <span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;edited_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">req</span><span class="p">[</span><span class="s1">&#39;userCtx&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">doc</span><span class="p">,</span> <span class="s1">&#39;Edited World!&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="filter-functions">
<span id="filterfun"></span><h2>3.1.5. Filter Functions<a class="headerlink" href="#filter-functions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt>
<code class="descname">filterfun</code><span class="sig-paren">(</span><em>doc</em>, <em>req</em><span class="sig-paren">)</span></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>doc</strong> – The document that is being processed</li>
<li><strong>req</strong> – <a class="reference internal" href="../json-structure.html#request-object"><span class="std std-ref">Request object</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">Boolean value: <code class="docutils literal"><span class="pre">true</span></code> means that <cite>doc</cite> passes the filter rules,
<code class="docutils literal"><span class="pre">false</span></code> means that it does not.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>Filter functions mostly act like <a class="reference internal" href="#showfun"><span class="std std-ref">Show Functions</span></a> and <a class="reference internal" href="#listfun"><span class="std std-ref">List Functions</span></a>: they
format, or <em>filter</em> the <a class="reference internal" href="../api/database/changes.html#changes"><span class="std std-ref">changes feed</span></a>.</p>
<div class="section" id="classic-filters">
<h3>3.1.5.1. Classic Filters<a class="headerlink" href="#classic-filters" title="Permalink to this headline">¶</a></h3>
<p>By default the changes feed emits all database documents changes. But if you’re
waiting for some special changes, processing all documents is inefficient.</p>
<p>Filters are special design document functions that allow the changes feed to
emit only specific documents that pass filter rules.</p>
<p>Let’s assume that our database is a mailbox and we need to handle only new mail
events (documents with the status <cite>new</cite>). Our filter function would look like
this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="c1">// we need only `mail` documents</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;mail&#39;</span><span class="p">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// we&#39;re interested only in `new` ones</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="s1">&#39;new&#39;</span><span class="p">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// passed!</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Filter functions must return <code class="docutils literal"><span class="pre">true</span></code> if a document passed all the rules.  Now,
if you apply this function to the changes feed it will emit only changes about
“new mails”:</p>
<div class="highlight-default"><div class="highlight"><pre>GET /somedatabase/_changes?filter=mailbox/new_mail HTTP/1.1
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="s2">&quot;1-g1AAAAF9eJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBMZc4EC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HqQ_kQG3qgSQqnoCqvJYgCRDA5ACKpxPWOUCiMr9hFUegKi8T1jlA4hKkDuzAC2yZRo&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;df8eca9da37dade42ee4d7aa3401f1dd&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-c2e0085a21d34fa1cecb6dc26a4ae657&quot;</span><span class="p">}]},</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="s2">&quot;9-g1AAAAIreJyVkEsKwjAURUMrqCOXoCuQ5MU0OrI70XyppcaRY92J7kR3ojupaSPUUgqWwAu85By4t0AITbJYo5k7aUNSAnyJ_SGFf4gEkvOyLPMsFtHRL8ZKaC1M0v3eq5ALP-X2a0G1xYKhgnONpmenjT04o_v5tOJ3LV5itTES_uP3FX9ppcAACaVsQAo38hNd_eVFt8ZklVljPqSPYLoH06PJhG0Cxq7-yhQcz-B4_fQCjFuqBjjewVF3E9cORoExSrpU_gHBTo5m&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;df8eca9da37dade42ee4d7aa34024714&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-29d748a6e87b43db967fe338bcb08d74&quot;</span><span class="p">}]},</span>
<span class="p">],</span>
<span class="s2">&quot;last_seq&quot;</span><span class="o">:</span><span class="s2">&quot;10-g1AAAAIreJyVkEsKwjAURR9tQR25BF2B5GMaHdmdaNIk1FLjyLHuRHeiO9Gd1LQRaimFlsALvOQcuLcAgGkWKpjbs9I4wYSvkDu4cA-BALkoyzLPQhGc3GKSCqWEjrvfexVy6abc_SxQWwzRVHCuYHaxSpuj1aqfTyp-3-IlSrdakmH8oeKvrRSIkJhSNiKFjdyEm7uc6N6YTKo3iI_pw5se3vRsMiETE23WgzJ5x8s73n-9EMYNTUc4Pt5RdxPVDkYJYxR3qfwLwW6OZw&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Note that the value of <code class="docutils literal"><span class="pre">last_seq</span></code> is <cite>10-..</cite>, but we received only two records.
Seems like any other changes were for documents that haven’t passed our filter.</p>
<p>We probably need to filter the changes feed of our mailbox by more than a single
status value. We’re also interested in statuses like “spam” to update
spam-filter heuristic rules, “outgoing” to let a mail daemon actually send
mails, and so on. Creating a lot of similar functions that actually do similar
work isn’t good idea - so we need a dynamic filter.</p>
<p>You may have noticed that filter functions take a second argument named
<a class="reference internal" href="../json-structure.html#request-object"><span class="std std-ref">request</span></a>. This allows the creation of dynamic filters
based on query parameters, <a class="reference internal" href="../json-structure.html#userctx-object"><span class="std std-ref">user context</span></a> and more.</p>
<p>The dynamic version of our filter looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">req</span><span class="p">){</span>
    <span class="c1">// we need only `mail` documents</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;mail&#39;</span><span class="p">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// we&#39;re interested only in requested status</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">status</span><span class="p">){</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// passed!</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and now we have passed the <cite>status</cite> query parameter in the request to let our
filter match only the required documents:</p>
<div class="highlight-default"><div class="highlight"><pre>GET /somedatabase/_changes?filter=mailbox/by_status&amp;status=new HTTP/1.1
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="s2">&quot;1-g1AAAAF9eJzLYWBg4MhgTmHgz8tPSTV0MDQy1zMAQsMcoARTIkOS_P___7MymBMZc4EC7MmJKSmJqWaYynEakaQAJJPsoaYwgE1JM0o1TjQ3T2HgLM1LSU3LzEtNwa3fAaQ_HqQ_kQG3qgSQqnoCqvJYgCRDA5ACKpxPWOUCiMr9hFUegKi8T1jlA4hKkDuzAC2yZRo&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;df8eca9da37dade42ee4d7aa3401f1dd&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-c2e0085a21d34fa1cecb6dc26a4ae657&quot;</span><span class="p">}]},</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="s2">&quot;9-g1AAAAIreJyVkEsKwjAURUMrqCOXoCuQ5MU0OrI70XyppcaRY92J7kR3ojupaSPUUgqWwAu85By4t0AITbJYo5k7aUNSAnyJ_SGFf4gEkvOyLPMsFtHRL8ZKaC1M0v3eq5ALP-X2a0G1xYKhgnONpmenjT04o_v5tOJ3LV5itTES_uP3FX9ppcAACaVsQAo38hNd_eVFt8ZklVljPqSPYLoH06PJhG0Cxq7-yhQcz-B4_fQCjFuqBjjewVF3E9cORoExSrpU_gHBTo5m&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;df8eca9da37dade42ee4d7aa34024714&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;1-29d748a6e87b43db967fe338bcb08d74&quot;</span><span class="p">}]},</span>
<span class="p">],</span>
<span class="s2">&quot;last_seq&quot;</span><span class="o">:</span><span class="s2">&quot;10-g1AAAAIreJyVkEsKwjAURR9tQR25BF2B5GMaHdmdaNIk1FLjyLHuRHeiO9Gd1LQRaimFlsALvOQcuLcAgGkWKpjbs9I4wYSvkDu4cA-BALkoyzLPQhGc3GKSCqWEjrvfexVy6abc_SxQWwzRVHCuYHaxSpuj1aqfTyp-3-IlSrdakmH8oeKvrRSIkJhSNiKFjdyEm7uc6N6YTKo3iI_pw5se3vRsMiETE23WgzJ5x8s73n-9EMYNTUc4Pt5RdxPVDkYJYxR3qfwLwW6OZw&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>and we can easily change filter behavior with:</p>
<div class="highlight-default"><div class="highlight"><pre>GET /somedatabase/_changes?filter=mailbox/by_status&amp;status=spam HTTP/1.1
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="p">[</span>
<span class="p">{</span><span class="s2">&quot;seq&quot;</span><span class="o">:</span><span class="s2">&quot;6-g1AAAAIreJyVkM0JwjAYQD9bQT05gk4gaWIaPdlNNL_UUuPJs26im-gmuklMjVClFFoCXyDJe_BSAsA4jxVM7VHpJEswWyC_ktJfRBzEzDlX5DGPDv5gJLlSXKfN560KMfdTbL4W-FgM1oQzpmByskqbvdWqnc8qfvvHCyTXWuBu_K7iz38VCOOUENqjwg79hIvfvOhamQahROoVYn3-I5huwXSvm5BJsTbLTk3B8QiO58-_YMoMkT0cr-BwdRElmFKSNKniDcAcjmM&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;8960e91220798fc9f9d29d24ed612e0d&quot;</span><span class="p">,</span><span class="s2">&quot;changes&quot;</span><span class="o">:</span><span class="p">[{</span><span class="s2">&quot;rev&quot;</span><span class="o">:</span><span class="s2">&quot;3-cc6ff71af716ddc2ba114967025c0ee0&quot;</span><span class="p">}]},</span>
<span class="p">],</span>
<span class="s2">&quot;last_seq&quot;</span><span class="o">:</span><span class="s2">&quot;10-g1AAAAIreJyVkEsKwjAURR9tQR25BF2B5GMaHdmdaNIk1FLjyLHuRHeiO9Gd1LQRaimFlsALvOQcuLcAgGkWKpjbs9I4wYSvkDu4cA-BALkoyzLPQhGc3GKSCqWEjrvfexVy6abc_SxQWwzRVHCuYHaxSpuj1aqfTyp-3-IlSrdakmH8oeKvrRSIkJhSNiKFjdyEm7uc6N6YTKo3iI_pw5se3vRsMiETE23WgzJ5x8s73n-9EMYNTUc4Pt5RdxPVDkYJYxR3qfwLwW6OZw&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Combining filters with a <cite>continuous</cite> feed allows creating powerful event-driven
systems.</p>
</div>
<div class="section" id="view-filters">
<span id="viewfilter"></span><h3>3.1.5.2. View Filters<a class="headerlink" href="#view-filters" title="Permalink to this headline">¶</a></h3>
<p>View filters are the same as classic filters above, with one small difference:
they use the <cite>map</cite> instead of the <cite>filter</cite> function of a view, to filter the
changes feed. Each time a key-value pair is emitted from the <cite>map</cite> function, a
change is returned. This allows avoiding filter functions that mostly do the
same work as views.</p>
<p>To use them just pass <cite>filter=_view</cite> and <cite>view=designdoc/viewname</cite> as request
parameters to the <a class="reference internal" href="../api/database/changes.html#changes"><span class="std std-ref">changes feed</span></a>:</p>
<div class="highlight-default"><div class="highlight"><pre>GET /somedatabase/_changes?filter=_view&amp;view=dname/viewname  HTTP/1.1
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since view filters use <cite>map</cite> functions as filters, they can’t show any
dynamic behavior since <a class="reference internal" href="../json-structure.html#request-object"><span class="std std-ref">request object</span></a> is not
available.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Guide:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://guide.couchdb.org/draft/notifications.html#filters">Guide to filter change notification</a></li>
</ul>
</dd>
</dl>
</div>
</div>
</div>
<div class="section" id="validate-document-update-functions">
<span id="vdufun"></span><h2>3.1.6. Validate Document Update Functions<a class="headerlink" href="#validate-document-update-functions" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="validatefun">
<code class="descname">validatefun</code><span class="sig-paren">(</span><em>newDoc</em>, <em>oldDoc</em>, <em>userCtx</em>, <em>secObj</em><span class="sig-paren">)</span><a class="headerlink" href="#validatefun" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Arguments:</th><td class="field-body"><ul class="first simple">
<li><strong>newDoc</strong> – New version of document that will be stored.</li>
<li><strong>oldDoc</strong> – Previous version of document that is already stored.</li>
<li><strong>userCtx</strong> – <a class="reference internal" href="../json-structure.html#userctx-object"><span class="std std-ref">User Context Object</span></a></li>
<li><strong>secObj</strong> – <a class="reference internal" href="../json-structure.html#security-object"><span class="std std-ref">Security Object</span></a></li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Throws:</th><td class="field-body"><p class="first"><code class="docutils literal"><span class="pre">forbidden</span></code> error to gracefully prevent document storing.</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Throws:</th><td class="field-body"><p class="first last"><code class="docutils literal"><span class="pre">unauthorized</span></code> error to prevent storage and allow the user to
re-auth.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<p>A design document may contain a function named <cite>validate_doc_update</cite>
which can be used to prevent invalid or unauthorized document update requests
from being stored.  The function is passed the new document from the update
request, the current document stored in the database, a <a class="reference internal" href="../json-structure.html#userctx-object"><span class="std std-ref">User Context Object</span></a>
containing information about the user writing the document (if present), and
a <a class="reference internal" href="../json-structure.html#security-object"><span class="std std-ref">Security Object</span></a> with lists of database security roles.</p>
<p>Validation functions typically examine the structure of the new document to
ensure that required fields are present and to verify that the requesting user
should be allowed to make changes to the document properties.  For example,
an application may require that a user must be authenticated in order to create
a new document or that specific document fields be present when a document
is updated. The validation function can abort the pending document write
by throwing one of two error objects:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// user is not authorized to make the change but may re-authenticate</span>
<span class="k">throw</span><span class="p">({</span> <span class="nx">unauthorized</span><span class="o">:</span> <span class="s1">&#39;Error message here.&#39;</span> <span class="p">});</span>

<span class="c1">// change is not allowed</span>
<span class="k">throw</span><span class="p">({</span> <span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Error message here.&#39;</span> <span class="p">});</span>
</pre></div>
</div>
<p>Document validation is optional, and each design document in the database may
have at most one validation function.  When a write request is received for
a given database, the validation function in each design document in that
database is called in an unspecified order.  If any of the validation functions
throw an error, the write will not succeed.</p>
<p><strong>Example</strong>: The <code class="docutils literal"><span class="pre">_design/_auth</span></code> ddoc from <cite>_users</cite> database uses a validation
function to ensure that documents contain some required fields and are only
modified by a user with the <code class="docutils literal"><span class="pre">_admin</span></code> role:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">newDoc</span><span class="p">,</span> <span class="nx">oldDoc</span><span class="p">,</span> <span class="nx">userCtx</span><span class="p">,</span> <span class="nx">secObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">_deleted</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// allow deletes by admins and matching users</span>
        <span class="c1">// without checking the other fields</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_admin&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">(</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="nx">oldDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Only admins may delete other user docs.&#39;</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">oldDoc</span> <span class="o">&amp;&amp;</span> <span class="nx">oldDoc</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span> <span class="o">:</span> <span class="s1">&#39;doc.type must be user&#39;</span><span class="p">});</span>
    <span class="p">}</span> <span class="c1">// we only allow user docs for now</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;doc.name is required&#39;</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;doc.roles must exist&#39;</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;doc.roles must be an array&#39;</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">_id</span> <span class="o">!==</span> <span class="p">(</span><span class="s1">&#39;org.couchdb.user:&#39;</span> <span class="o">+</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span>
            <span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Doc ID must be of the form org.couchdb.user:name&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">oldDoc</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// validate all updates</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oldDoc</span><span class="p">.</span><span class="nx">name</span> <span class="o">!==</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Usernames can not be changed.&#39;</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">password_sha</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">salt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span>
            <span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Users with password_sha must have a salt.&#39;</span> <span class="o">+</span>
                <span class="s1">&#39;See /_utils/script/couch.js for example code.&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">is_server_or_database_admin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">userCtx</span><span class="p">,</span> <span class="nx">secObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// see if the user is a server admin</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;_admin&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// a server admin</span>
        <span class="p">}</span>

        <span class="c1">// see if the user a database admin specified by name</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">secObj</span> <span class="o">&amp;&amp;</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span> <span class="o">&amp;&amp;</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span><span class="p">.</span><span class="nx">names</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// database admin</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// see if the user a database admin specified by role</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">secObj</span> <span class="o">&amp;&amp;</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span> <span class="o">&amp;&amp;</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span><span class="p">.</span><span class="nx">roles</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">db_roles</span> <span class="o">=</span> <span class="nx">secObj</span><span class="p">.</span><span class="nx">admins</span><span class="p">.</span><span class="nx">roles</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">idx</span> <span class="o">&lt;</span> <span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">user_role</span> <span class="o">=</span> <span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">[</span><span class="nx">idx</span><span class="p">];</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">db_roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">user_role</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="c1">// role matches!</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// default to no admin</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">is_server_or_database_admin</span><span class="p">(</span><span class="nx">userCtx</span><span class="p">,</span> <span class="nx">secObj</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oldDoc</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// validate non-admin updates</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">name</span> <span class="o">!==</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span><span class="p">({</span>
                    <span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;You may only update your own user document.&#39;</span>
                <span class="p">});</span>
            <span class="p">}</span>
            <span class="c1">// validate role updates</span>
            <span class="kd">var</span> <span class="nx">oldRoles</span> <span class="o">=</span> <span class="nx">oldDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">newRoles</span> <span class="o">=</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">oldRoles</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="nx">newRoles</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Only _admin may edit roles&#39;</span><span class="p">});</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">oldRoles</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">oldRoles</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">newRoles</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
                    <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Only _admin may edit roles&#39;</span><span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Only _admin may set roles&#39;</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// no system roles in users db</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">roles</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span>
                <span class="nx">forbidden</span><span class="o">:</span>
                <span class="s1">&#39;No system roles (starting with underscore) in users db.&#39;</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// no system names as names</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Username may not start with underscore.&#39;</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">badUserNameChars</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">badUserNameChars</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">newDoc</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">badUserNameChars</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span><span class="p">({</span><span class="nx">forbidden</span><span class="o">:</span> <span class="s1">&#39;Character `&#39;</span> <span class="o">+</span> <span class="nx">badUserNameChars</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span>
                    <span class="s1">&#39;` is not allowed in usernames.&#39;</span><span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">return</span></code> statement is used only for function, it has no impact on
the validation process.</p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt>CouchDB Guide:</dt>
<dd><ul class="first last simple">
<li><a class="reference external" href="http://guide.couchdb.org/editions/1/en/validation.html">Validation Functions</a></li>
</ul>
</dd>
</dl>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="views/index.html" class="btn btn-neutral float-right" title="3.2. Guide to Views" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="3. Design Documents" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Apache Software Foundation. CouchDB® is a registered trademark of the Apache Software Foundation.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.3.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>